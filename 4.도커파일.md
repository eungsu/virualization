# 도커파일(Dockerfile)

## 도커파일(Dockerfile)이란 무엇인가?

### 정의

- **Dockerfile**은 도커 이미지를 생성할 때 사용되는 텍스트 파일이다.
- **Dockerfile**을 이용하면 도커 이미지를 구성하는 과정을 자동화하고, 이미지가 어떻게 빌드되어야 하는지 세부 사항을 정의할 수 있다.
- **Dockerfile**을 이용하면 이미지 빌드를 반복적으로 수행하는 것이 가능하고, 버전 관리 시스템을 통해 이미지 구성을 관리할 수 있다.

### 사용 목적

- 애플리케이션 배포 자동화
  - 소프트웨어 설치, 설정, 의존성 관리 등을 한 번 정의하면 동일한 설정으로 여러 환경에서 이미지를 재현할 수 있다.
  - 개발 환경, 테스트 환경, 프로덕션 환경 등에서 동일한 이미지를 실행.
- 일관성 있는 환경 제공
  - Dockerfile을 사용하면 개발자, 테스트 엔지니어, 운영팀 모두 동일한 이미지를 기반으로 작업하므로 환경 간 차이에서 발생하는 문제를 방지할 수 있다.
- 이미지 재사용 및 버전 관리
  - 도커 이미지를 빌드하면 이후 동일한 애플리케이션의 새 버전을 배포할 때, 기존 이미지를 재사용하고 필요한 부분만 업데이트 가능.
  - 베이스 이미지에서 새로운 라이브러리를 추가하거나 특정 버전을 업데이트.
- CI/CD 파이프라인 통합
  - Dockerfile은 지속적 통합(CI) 및 지속적 배포(CD) 과정에서 자동으로 이미지를 빌드하고, 테스트 및 배포하는 데 활용된다.
- 애플리케이션 이식성 향상
  - Dockerfile로 생성된 이미지는 도커가 설치된 모든 플랫폼에서 실행될 수 있기 때문에 이는 환경 종속성을 제거하고 이식성을 높이는 데 기여한다.
- 운영 효율성 개선
  - 애플리케이션 실행에 필요한 모든 것을 이미 이미지 안에 포함시킬 수 있어, 운영팀이 복잡한 설치 과정 없이 이미지를 실행할 수 있다.

## 도커 파일 예제

```Dockerfile
# 베이스 이미지로 java 17버전이 포함된 도커이미지를 사용한다.
FROM openjdk:17-jdk-alpine

# 메이븐을 이용해서 프로젝트를 패키징 한다.
CMD ["./mvnw", "clean", "package"]

# 메이븐으로 패키징된 jar파일의 위치와 파일명을 JAR_FILE 변수에 설정한다.
ARG JAR_FILE=target/*.jar

# JAR_FILE 변수에 지정된 파일을 app.jar라는 이름으로 컨테이너에 추가한다.
COPY ${JAR_FILE} app.jar

# 컨테이너가 사용할 포트번호를 설정한다.
EXPOSE 8080

# 컨테이너가 실행될 때 기본적으로 실행될 명령어를 설정한다.
# 이 경우에는 app.jar 자바 애플리케이션을 실행한다.
ENTRYPOINT ["java","-jar","/app.jar"]
```

## 도커파일 문법

|명령어|설명|사용법 예시|
|---|---|---|
|```FROM```|도커 이미지 빌드의 기반이 되는 이미지를 지정한다|```FROM ububutu:20.04```|
|```WORKDIR```|명령러 실행 및 컨테이너 시작 시 사용할 작업 디렉토리를 지정한다. 이 후에 실행되는 모든 명령어는 해당 디렉토리를 기준으로 실행된다.|```WORKDIR /usr/src/app```|
|```RUN```|이미지를 빌드할 때 명령어를 실행하고, 실행 결과를 이미지에 저장합니다. 보통은 이미지 안에 특정 소프트웨어를 설치하기 위해서 사용한다.|```RUN apt-get update && apt install -y nginx```|
|```ENTRYPOINT```|컨테이너 실행 시 항상 실행되어야 하는 ***고정 명령어***를 지정합니다. ```CMD```와 달리 컨테이너 실행시 고정적으로 샐된다.|```ENTRYPOINT ["java","-jar","/app.jar"]```|
|```CMD```|도커 이미지로 컨테이너 시작될 때 실행된다. Dockerfile에 하나만 사용할 수 있다. ```docker run```명령어로 덮어쓸 수 있다. |```CMD ["node", "app.js"]```|
|```EXPOSE```|컨테이너로 들어오는 들어오는 요청을 리스닝하는 포트를 지정한다.|```EXPOSE 80```|
|```COPY```|```COPY``` 명령문은 호스트 컴퓨터에 있는 디렉토리나 파일을 도커 이미지의 파일 시스템으로 복사한다.|```COPY ${JAR_FILE} app.jar```|
|```ENV```|환경변수를 설정하기 위해서 사용한다. ```ENV```로 설정한 환경변수는 이미지 빌드과정 및 컨테이너에서 실행되는 애플리케이션에서도 사용할 수 있다.|```ENV NODE_ENV production```|
|```ARG```|도커 이미지를 빌드할 때 ```--build-arg <varname>=<value>``` 플래그를 사용해서 전달한 값을 변수로 저장할 때 사용한다. 빌드과정에서 아무값도 전달하지 않으면 설정된 기본값을 사용하도록 한다. |```ARG JAR_FILE=target/*.jar```|
|```VOLUME```|데이터 볼륨을 지정한다.|```VOLUME /data```|

## 주요 명령어

### 도커 이미지 빌드하기 : ```docker build```

```bash
docker build -t [도커허브 계정]/[이미지 이름]:[태그] .

# 도커파일을 이용해서 도커 이미지를 빌드한다.
```

### 이미지 태그 지정하기 : ```docker tag```

```bash
docker tag [로컬 이미지 이름]:[태그] [도커허브 계정]/[이미지 이름]:[태그]

# 이미지를 빌드할 때 도커 허브 계정명을 포함하지 않았다면, 
# 위의 명령어로 이미지를 도커 허브에 동록할 수 있는 형식으로 변경한다. 
```

### 도커 허브에 이미지 등록하기 : ```docker push```

```bash
docker push [도커허브 계정]/[이미지 이름]:[태그]

# 로컬 도커 이미지를 도커허브에 업로드한다.
# 도커 허브에 업로드하기 전에 도커 허브 로그인이 필요하다.
```

## 도커 허브에 도커 이미지 등록하기

- **도커 허브**는 도커에서 제공하는 공시 컨테이너 이미지 저장소 서비스다.
- **도커 허브**를 통해 개발자와 팀은 컨테이너 이미지를 저장, 공유, 배포할 수 있다.
- **도커 허브**는 클라우드 기반의 서비스로, 전 세계 개발자들이 표준화된 방식으로 애플리케이션을 배포학 관리할 수 있게 한다.

1. 도커 허브(Docker Hub) 계정을 생성한다.  
    - [Docker Hub](https://hub.docker.com/)에서 계정을 생성한다.
2. 도커 허브에 로그인한다.

    ```bash
    docker login

    # 도커 허브에 로그인한다.
    ```

3. 도커 이미지를 빌드한다.

    ```bash
    docker build -t rest-app:1.0 .

    # Dockerfile로 도커 이미지를 빌드한다.
    ```

4. 도커 이미지를 태그한다.

    ```bash
    docker tag rest-app:1.0 dockerhubusername/rest-app:1.0

    # 도커 이미지 이름을 도커허브에 푸시가능하게 변경한다.
    ```

5. 도커 이미지를 도커 허브에 푸시한다.

    ```bash
    docker push dockerhubusername/rest-app:1.0

    # 도커 이미지를 도커 허브에 푸시한다.
    # 도커 허브에 등록된 이미지는 도커 허브 사이트에서 확인할 수 있다.
    ```

6. 도커 이미지 다운로드

    ```bash
    docker pull dockerhubusername/rest-app:1.0
    ```
